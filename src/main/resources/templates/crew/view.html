<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Gachi Watch</title>
    <link rel="stylesheet" th:href="@{/css/crew/view.css}"> <!-- CSS 따로 연결 -->
    <style>


    </style>
</head>
<body>

<header class="main-header">
    <div class="logo-search">
        <a th:href="@{/}">
            <img th:src="@{/image/logo.png}" alt="Gachi Watch Logo" class="logo">
        </a>
        <form id="keywordForm" method="post" th:action="@{/content/keyword}">
            <input type="text" name="keyword" placeholder="콘텐츠, 키워드 입력" class="search-bar">
            <button class="search-button" type="submit">Search</button>
        </form>
    </div>
    <nav class="nav-menu">
        <a th:href="@{/content/search}">통합 콘텐츠</a>
        <a th:href="@{/content/recommend}">추천 콘텐츠</a>
        <a th:href="@{/crew/view}">공유 매칭</a>
        <a th:href="@{/account/logout}">
            <button class="logout">Logout</button>
        </a>
        <!-- 로그인 -> 홈화면 뷰 연결 위해 null-safe 처리 했습니다 -->
        <a th:if="${user != null}" th:href="@{/mypage}">
            <img th:src="@{'/image/' + ${user.profileImage}}" alt="사용자 프로필" class="profile-image">
        </a>
    </nav>
</header>
<div class="main-container" style="display: block;">
    <form action="/crew/create" method="get" style="text-align: center; display: inline;">
        <button class="create-btn" type="submit" style="margin: 0 auto;">크루 생성</button>
    </form>
    <form action="/crew/view" method="get" style="text-align: center; display: inline;">
        <button class="create-btn" type="submit" style="margin: 0 auto;">전체 크루 조회</button>
    </form>
    <form action="/crew/view" method="get" style="text-align: center;">
        <input type="hidden" name="myCrew" value="true"/>
        <button class="create-btn" type="submit" style=" margin: 0 auto;">나의 크루</button>
        </form>
    <form id="platformForm">
        <div class="form-group">
            <div class="ott-platforms">
                <div th:each="platform : ${platforms}" class="platform-option">
                    <input type="radio"
                           name="platform"
                           th:id="${'platform_' + platform.name()}"
                           th:value="${platform.name()}"
                           class="platform-radio"
                           th:checked="${selectedPlatform != null and platform.name() == selectedPlatform}"
                           required />
                    <label th:for="${'platform_' + platform.name()}"
                           th:classappend="${selectedPlatform != null and platform.name() == selectedPlatform} ? ' selected' : ''"
                           class="platform-label">
                        <img th:src="@{'/image/' + ${platform.name().toLowerCase()} + '.png'}"
                             th:alt="${platform.label}" />
                    </label>
                </div>
            </div>
            <div class="button-group" style="display: flex; gap: 6px;">
                <button style="margin-left:auto;" class="join-btn">플랫폼 선택</button>
                <button style="margin-left:auto;" class="join-btn" id="grey-btn" onclick="clearPlatformAndSubmit()">플랫폼 해제</button>
            </div>
        </div>
    </form>
    <div class="party-list">
        <!-- 크루 카드 목록 -->
        <div class="party-card" th:each="crew : ${crewPage.content}" th:attr="data-crew-id=${crew.crewId}">
            <p th:text="${crew.crewName}"></p>
            <!-- 기타 정보 -->
            <img class="party-logo" th:src="@{'/image/' + ${crew.platform.name().toLowerCase()} + '.png'}" alt="플랫폼">
            <p th:text="${crew.payment + '원'}">17900원</p>
            <p>인원: <span th:text="${crew.maxMember}">3</span> / <span th:text="${crew.maxMember}">4</span></p>
            <p>결제일: <span th:text="${#dates.format(crew.payDate, 'd')} + '일'">매달 7일</span></p>
            <!--<p>최소기간: 6개월</p>-->
            <th:block th:if="${myCrew}">
                <a th:href="@{'/crew/crewpage/' + ${crew.crewId}}" class="join-btn">크루 입장</a>
            </th:block>
            <th:block th:unless="${myCrew}">
                <button class="join-btn join-crew-btn">가입하기</button>
            </th:block>
        </div>
    </div>

    <!-- 페이지네이션 -->
    <div th:if="${crewPage.totalElements == 0}" style="text-align: center; margin-top: 2rem;">
        <p>조회된 크루가 없습니다.</p>
    </div>

    <div th:unless="${crewPage.totalElements == 0}" class="pagination">
        <a th:href="@{/crew/view(page=${crewPage.number - 1}, myCrew=${myCrew}, platform=${selectedPlatform})}" th:if="${!crewPage.first}">&lt; Prev</a>
        <span th:each="i : ${#numbers.sequence(1, crewPage.totalPages)}">
            <a th:href="@{/crew/view(page=${i - 1}, myCrew=${myCrew}, platform=${selectedPlatform})}" th:text="${i}"></a>
        </span>
        <a th:href="@{/crew/view(page=${crewPage.number + 1}, myCrew=${myCrew}, platform=${selectedPlatform})}" th:if="${!crewPage.last}">Next &gt;</a>
    </div>

    <div id="joinModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <p>이 크루에 가입 신청하시겠습니까?</p>
            <form id="joinForm" method="post" action="/crew/join" th:action="@{/crew/join}">
                <input type="hidden" name="crewId" id="modalCrewId">
                <!--<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                <button type="submit">신청</button>
            </form>
        </div>
    </div>
</div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const radios = document.querySelectorAll(".platform-radio");
        const labels = document.querySelectorAll(".platform-label");

        radios.forEach((radio, idx) => {
            radio.addEventListener("change", function () {
                labels.forEach(label => label.classList.remove("selected"));
                if (radio.checked) {
                    labels[idx].classList.add("selected");
                }
            });
        });
    });

    function clearPlatformAndSubmit() {
        const form = document.querySelector('#platformForm');

        const platforms = form.querySelectorAll('input[name="platform"]');
        platforms.forEach(radio => radio.checked = false);

        form.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('joinModal');
    const closeModal = document.getElementById('closeModal');
    const crewIdInput = document.getElementById('modalCrewId');
    const joinButtons = document.querySelectorAll('.join-crew-btn');

    joinButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
            const crewCard = btn.closest('.party-card');
            const crewId = crewCard.getAttribute('data-crew-id');

            crewIdInput.value = crewId;
            modal.style.display = 'block';
        });
    });

    closeModal.addEventListener('click', function () {
        modal.style.display = 'none';
    });

    window.addEventListener('click', function (event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
</html>
